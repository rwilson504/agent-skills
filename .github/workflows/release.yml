name: Build and Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Build distribution packages
        run: |
          chmod +x build.sh
          ./build.sh "${{ steps.version.outputs.VERSION }}"

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          # Discover skills
          SKILL_LIST=""
          for skill_file in */SKILL.md; do
            if [ -f "$skill_file" ]; then
              dir=$(dirname "$skill_file")
              # Extract skill name from YAML frontmatter
              name=$(grep -m1 '^name:' "$skill_file" | sed 's/^name:\s*//')
              SKILL_LIST="${SKILL_LIST}- **${name:-$dir}** — \`${dir}-v${VERSION}.zip\`\n"
            fi
          done

          cat <<EOF > release_notes.md
          ## Distribution Packages

          ### Complete Bundle (Recommended)
          - **agent-skills-v${VERSION}.zip** — All skills in one package

          ### Individual Skills
          ${SKILL_LIST}
          ### Installation
          Download the complete bundle or individual skill zips from the assets below.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "v${{ steps.version.outputs.VERSION }}"
          body_path: release_notes.md
          files: dist/*.zip
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
